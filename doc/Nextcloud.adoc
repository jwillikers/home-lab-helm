= Nextcloud
:keywords: container helm k8s kubernetes linux podman systemd
:Nextcloud: https://nextcloud.com/[Nextcloud]

The {Nextcloud} pod uses the Nextcloud PHP-FPM container image.
Redis provides image caching, and imaginary handles image previews. 
Background jobs are carried out by a separate container which is executed every five minutes by a systemd timer.

== Usage

The Nextcloud pod uses configuration files provided by the https://github.com/jwillikers/nextcloud-config[Nextcloud Config] repository.
In addition, a separate systemd service and timer need to be configured to run background jobs for the Nextcloud server.
Follow the commands below to install the Nextcloud Config repository and configure the container for background jobs.

. Create the `~/Projects` directory.
+
[,sh]
----
mkdir -p ~/Projects
----

. Clone this repository under the `~/Projects` directory.
+
[,sh]
----
git -C ~/Projects clone https://github.com/jwillikers/nextcloud-config.git
----

. Create the directory for Podman's systemd container generator.
+
[,sh]
----
mkdir -p ~/.config/containers/systemd
----

. Copy the `podman.network`, `nextcloud.kube`, and `nextcloud-cron.container` files to the `~/.config/containers/systemd/` directory.
+
[,sh]
----
cp nextcloud.kube nextcloud-cron.container ~/.config/containers/systemd/
----

. Create the systemd directory for user units.
+
[,sh]
----
mkdir -p ~/.config/systemd/user/
----

. Copy the `nextcloud-cron.timer` file to the `~/.config/systemd/user/` directory.
+
[,sh]
----
cp nextcloud-cron.timer ~/.config/systemd/user/
----

. Fill in any missing secrets in the `nextcloud-secrets.yaml` file.
+
[TIP]
====
You can generate a random password with the following command.

[,sh]
----
tr -cd '[:alnum:]' < /dev/urandom | fold -w30 | head -n1
----
====

. Import the secrets in Podman with the `podman play kube` command.
+
[,sh]
----
podman play kube nextcloud-secrets.yaml
----

. Load the newly added systemd units.
+
[,sh]
----
systemctl --user daemon-reload
----

. Start the desired Nextcloud pod.
+
[,sh]
----
systemctl --user start nextcloud
----

. Wait for the installation of the Nextcloud container to complete.

. Enable and start the timer for the background job container.
+
[,sh]
----
systemctl --user enable --now nextcloud-cron.timer
----

== Maintenance

To generate missing indices use the following command.

[,sh]
----
podman exec --tty nextcloud-nextcloud-server ./occ db:add-missing-indices
----

== References

.Documentation
* https://github.com/h2non/imaginary[imaginary]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/automatic_configuration.html[Nextcloud Admin Manual: Automatic setup]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html[Nextcloud Admin Manual: Background jobs]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/config_sample_php_parameters.html#deleted-items-trash-bin[Nextcloud Admin Manual: Configuration Parameters - Deleted Items (trash bin)]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/email_configuration.html[Nextcloud Admin Manual: Email]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/index.html[Nextcloud Admin Manual: Nextcloud configuration]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/reverse_proxy_configuration.html[Nextcloud Admin Manual: Reverse proxy]
* https://docs.nextcloud.com/server/latest/admin_manual/installation/server_tuning.html#previews[Nextcloud Admin Manual: Server tuning - Previews]
* https://docs.nextcloud.com/server/latest/admin_manual/installation/server_tuning.html#tune-php-fpm[Nextcloud Admin Manual: Server tuning - Tune PHP-FPM]
* https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/files_locking_transactional.html[Nextcloud Admin Manual: Transactional file locking]
* https://github.com/nextcloud/docker[Nextcloud Docker]
* https://hub.docker.com/_/redis[redis Official Docker Image] 

.See Also
* https://github.com/nextcloud/all-in-one[Nextcloud All-in-One]
